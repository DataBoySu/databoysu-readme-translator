name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Pre-flight Checks
        run: |
          echo "Checking critical files..."
          test -f action.yml
          test -f entrypoint.sh
          test -f translator/translate.py
          test -f requirements.txt
          
          echo "Checking Python syntax..."
          python -m py_compile translator/translate.py

      - name: Lint Entrypoint
        run: shellcheck entrypoint.sh

      - name: Create Dummy README
        run: |
          echo "# Test Project" > TEST_README.md
          echo "This is a test description for the AI translator." >> TEST_README.md
          echo "## Features" >> TEST_README.md
          echo "- Fast translation" >> TEST_README.md

      - name: Test Navbar Mode (Logic Check)
        uses: ./
        with:
          mode: 'navbar'
          readme_path: 'TEST_README.md'

      - name: Verify Navbar Logic
        run: |
          grep -q "<!--START_SECTION:navbar-->" TEST_README.md
          grep -q "<!--END_SECTION:navbar-->" TEST_README.md
          echo "Navbar logic verified."

      - name: Run Full Translation (French)
        # This verifies the end-to-end flow including model download and LLM execution.
        uses: ./ # Uses the action from the current repository
        with:
          lang: 'fr'
          readme_path: 'TEST_README.md'

      - name: Verify Output
        run: |
          if [ ! -f "locales/README.fr.md" ]; then
            echo "Error: Translation file not generated."
            exit 1
          fi

          echo "Checking Root README Navbar..."
          if ! grep -q "<!--START_SECTION:navbar-->" TEST_README.md; then
            echo "Error: Navbar not injected into TEST_README.md"
            exit 1
          fi
          grep -q "README.md" TEST_README.md
          grep -q "locales/README.fr.md" TEST_README.md

          echo "Checking Locale README Navbar..."
          if ! grep -q "<!--START_SECTION:navbar-->" locales/README.fr.md; then
            echo "Error: Navbar not injected into locales/README.fr.md"
            exit 1
          fi
          grep -q "../README.md" locales/README.fr.md
          grep -q "README.fr.md" locales/README.fr.md

          echo "End-to-end verification passed."
